{% extends 'shop/base_uk.html' %}

{% load i18n %}



{% block content %}

<div class="product-detail">

    <div class="media">

        <div class="product-gallery" id="productGallery" style="max-width: 500px; margin: 0 auto; text-align: center; border-radius: 12px; overflow: hidden;" data-images="{% for u in images %}{{ u }}{% if not forloop.last %}||{% endif %}{% endfor %}">

            {% if images and images.0 %}

                <img id="productImage" class="clickable-image" style="max-height: 500px; width: auto; max-width: 100%; border-radius: 12px; display: block; margin: 0 auto;" src="{{ images.0 }}" alt="{{ candle.name }}" onclick="openImageModal(this)">

            {% elif candle.image and candle.image.url %}

                <img id="productImage" class="clickable-image" style="max-height: 500px; width: auto; max-width: 100%; border-radius: 12px; display: block; margin: 0 auto;" src="{{ candle.image.url }}" alt="{{ candle.name }}" onclick="openImageModal(this)">

            {% else %}

                <img id="productImage" class="clickable-image" style="max-height: 500px; width: auto; max-width: 100%; border-radius: 12px; display: block; margin: 0 auto;" src="https://picsum.photos/seed/{{ candle.pk|default:0 }}/800/600" alt="{{ candle.name }}" onclick="openImageModal(this)">

            {% endif %}



            {% if images|length > 1 %}

                <div class="gallery-controls">

                    <button type="button" class="gallery-nav" onclick="galleryPrev()">‹</button>

                    <div class="gallery-thumbs">

                        {% for u in images %}

                            <button type="button" class="gallery-thumb" data-idx="{{ forloop.counter0 }}" onclick="gallerySetFromThumb(this)">

                                <img src="{{ u }}" alt="{{ candle.name }}">

                            </button>

                        {% endfor %}

                    </div>

                    <button type="button" class="gallery-nav" onclick="galleryNext()">›</button>

                </div>

            {% endif %}

        </div>

    </div>

    <div class="meta">

        <h2>{{ candle.display_name }}</h2>

            {% if candle.category_links.exists %}
                <p class="aroma">
                    Категории:
                    {% for link in candle.category_links.all %}
                        <span class="category-chip">
                            {{ link.category.display_name }}
                        </span>
                    {% endfor %}
                </p>
            {% endif %}


        <p class="desc">{{ candle.display_description|linebreaksbr }}</p>

        <div class="actions">

            <strong class="price">{{ candle.price }} ₴</strong>

            <button class="btn btn-add" data-pk="{{ candle.pk }}">Додати до кошика</button>

        </div>

    </div>

</div>



<!-- Image Modal -->

<div class="image-modal" id="imageModal">

    <div class="modal-content" onclick="event.stopPropagation()">

        <span class="modal-close" onclick="closeImageModal()">&times;</span>

        <img id="modalImage" src="" alt="Product Image">

    </div>

</div>



<script>

let galleryIndex = 0;

let touchStartX = null;



function getGalleryImages() {

    const el = document.getElementById('productGallery');

    if (!el) return [];

    const raw = el.getAttribute('data-images') || '';

    if (!raw) return [];

    return raw.split('||').filter(Boolean);

}



function galleryUpdateActiveThumb() {

    const thumbs = document.querySelectorAll('.gallery-thumb');

    thumbs.forEach((t) => t.classList.remove('is-active'));

    const active = document.querySelector(`.gallery-thumb[data-idx="${galleryIndex}"]`);

    if (active) {

        active.classList.add('is-active');

        if (active.scrollIntoView) {

            active.scrollIntoView({block: 'nearest', inline: 'nearest'});

        }

    }

}



function gallerySet(idx) {

    const imgs = getGalleryImages();

    if (!imgs.length) return;

    galleryIndex = Math.max(0, Math.min(idx, imgs.length - 1));

    const imgEl = document.getElementById('productImage');

    if (imgEl) imgEl.src = imgs[galleryIndex];

    galleryUpdateActiveThumb();

}



function gallerySetFromThumb(btn) {

    const idx = Number(btn && btn.dataset ? btn.dataset.idx : 0);

    gallerySet(isNaN(idx) ? 0 : idx);

}



function galleryPrev() {

    const imgs = getGalleryImages();

    if (!imgs.length) return;

    galleryIndex = (galleryIndex - 1 + imgs.length) % imgs.length;

    gallerySet(galleryIndex);

}



function galleryNext() {

    const imgs = getGalleryImages();

    if (!imgs.length) return;

    galleryIndex = (galleryIndex + 1) % imgs.length;

    gallerySet(galleryIndex);

}



document.addEventListener('keydown', function(e) {

    const imgs = getGalleryImages();

    if (imgs.length <= 1) return;

    if (document.body.classList.contains('image-modal-open')) return;

    if (e.key === 'ArrowLeft') galleryPrev();

    if (e.key === 'ArrowRight') galleryNext();

});



document.addEventListener('DOMContentLoaded', function() {

    galleryUpdateActiveThumb();

    const imgEl = document.getElementById('productImage');

    if (!imgEl) return;

    imgEl.addEventListener('touchstart', function(e) {

        if (!e.touches || !e.touches.length) return;

        touchStartX = e.touches[0].clientX;

    }, {passive: true});

    imgEl.addEventListener('touchend', function(e) {

        if (touchStartX === null) return;

        const changed = e.changedTouches && e.changedTouches[0];

        if (!changed) return;

        const dx = changed.clientX - touchStartX;

        touchStartX = null;

        if (Math.abs(dx) < 30) return;

        if (dx > 0) galleryPrev();

        else galleryNext();

    }, {passive: true});

});



function openImageModal(img) {

    const modal = document.getElementById('imageModal');

    const modalImg = document.getElementById('modalImage');

    modalImg.src = img.src;

    modal.classList.add('active');

    document.body.classList.add('image-modal-open');

}



function closeImageModal() {

    const modal = document.getElementById('imageModal');

    modal.classList.remove('active');

    document.body.classList.remove('image-modal-open');

}



const modal = document.getElementById('imageModal');

modal.onclick = function(e) {

    if (e.target === modal) {

        closeImageModal();

    }

};



document.onkeydown = function(e) {

    if (e.key === 'Escape') {

        closeImageModal();

    }

};

</script>



{% endblock %}