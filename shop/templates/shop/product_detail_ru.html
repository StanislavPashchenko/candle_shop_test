{% extends 'shop/base_ru.html' %}

{% load i18n %}

{% block content %}

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="product-detail">

    <div class="media">

        <div class="product-gallery" id="productGallery" style="max-width: 500px; margin: 0 auto; text-align: center; border-radius: 12px; overflow: hidden;" data-images="{% for u in images %}{{ u }}{% if not forloop.last %}||{% endif %}{% endfor %}">

            {% if images and images.0 %}

                <img id="productImage" class="clickable-image" style="max-height: 500px; width: auto; max-width: 100%; border-radius: 12px; display: block; margin: 0 auto; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" src="{{ images.0 }}" alt="{{ candle.name }}" onclick="openImageModal(this)">

            {% elif candle.image and candle.image.url %}

                <img id="productImage" class="clickable-image" style="max-height: 500px; width: auto; max-width: 100%; border-radius: 12px; display: block; margin: 0 auto;" src="{{ candle.image.url }}" alt="{{ candle.name }}" onclick="openImageModal(this)">

            {% else %}

                <img id="productImage" class="clickable-image" style="max-height: 500px; width: auto; max-width: 100%; border-radius: 12px; display: block; margin: 0 auto;" src="https://picsum.photos/seed/{{ candle.pk|default:0 }}/800/600" alt="{{ candle.name }}" onclick="openImageModal(this)">

            {% endif %}

            {% if images|length > 1 %}

                <div class="gallery-controls">

                    <button type="button" class="gallery-nav" onclick="galleryPrev()">‹</button>

                    <div class="gallery-thumbs">

                        {% for u in images %}

                            <button type="button" class="gallery-thumb" data-idx="{{ forloop.counter0 }}" onclick="gallerySetFromThumb(this)">

                                <img src="{{ u }}" alt="{{ candle.name }}">

                            </button>

                        {% endfor %}

                    </div>

                    <button type="button" class="gallery-nav" onclick="galleryNext()">›</button>

                </div>

            {% endif %}

        </div>

    </div>

    <div class="meta">

        <h2>{{ candle.display_name }}</h2>

        <div style="margin: 6px 0 0; display: flex; gap: 8px; flex-wrap: wrap;">
            {% if not candle.is_available %}<span class="badge badge-oos">Нет в наличии</span>{% endif %}
            {% if candle.is_hit %}<span class="badge badge-hit">Хит</span>{% endif %}
            {% if candle.is_on_sale and candle.discount_percent %}<span class="badge badge-sale">-{{ candle.discount_percent }}%</span>{% endif %}
        </div>

        {% if candle.category_links.exists %}
            <p class="aroma">
                Категории:
                {% for link in candle.category_links.all %}
                    <span class="category-chip">
                        {{ link.category.display_name }}
                    </span>
                {% endfor %}
            </p>
        {% endif %}

        <div class="actions">

            <strong class="price" id="productPrice">{{ candle.price }} ₴</strong>

            {% if has_options %}
            <!-- Конфигуратор опций -->
            <div class="product-options" id="productOptions">
                {% for option in options_data %}
                <div class="option-item" data-option-id="{{ option.id }}" data-required="{{ option.is_required_effective|yesno:'true,false' }}">
                    <label class="option-label">
                        {{ option.name }}
                        {% if option.is_required_effective %}
                        <span class="required-mark">*</span>
                        {% endif %}
                    </label>

                    {% if option.input_type == 'select' %}
                    <div class="option-checkbox-group">
                        {% for value in option.values %}
                        <label class="checkbox-label">
                            <input type="radio" class="option-input option-checkbox" name="option_{{ option.id }}"
                                   value="{{ value.id }}" data-option-id="{{ option.id }}" data-price-modifier="{{ value.price_modifier }}" data-image-url="{{ value.image_url }}">
                            <span class="checkbox-text">{{ value.value }}{% if value.price_modifier != "0.00" %} ({{ value.price_modifier|floatformat:0 }} ₴){% endif %}</span>
                        </label>
                        {% endfor %}
                    </div>

                    {% elif option.input_type == 'radio' %}
                    <div class="option-radio-group">
                        {% for value in option.values %}
                        <label class="radio-label">
                            <input type="radio" class="option-input option-radio" name="option_{{ option.id }}"
                                   value="{{ value.id }}" data-option-id="{{ option.id }}" data-price-modifier="{{ value.price_modifier }}" data-image-url="{{ value.image_url }}">
                            <span class="radio-text">{{ value.value }}{% if value.price_modifier != "0.00" %} ({{ value.price_modifier|floatformat:0 }} ₴){% endif %}</span>
                        </label>
                        {% endfor %}
                    </div>

                    {% elif option.input_type == 'buttons' %}
                    <div class="option-buttons-group">
                        {% for value in option.values %}
                        <button type="button" class="option-btn" data-value-id="{{ value.id }}"
                                data-option-id="{{ option.id }}" data-price-modifier="{{ value.price_modifier }}" data-image-url="{{ value.image_url }}">
                            {{ value.value }}{% if value.price_modifier != "0.00" %}<br><small>+{{ value.price_modifier|floatformat:0 }} ₴</small>{% endif %}
                        </button>
                        {% endfor %}
                        <input type="hidden" class="option-input" name="option_{{ option.id }}" data-option-id="{{ option.id }}">
                    </div>
                    {% endif %}
                </div>
                {% endfor %}

                <div class="options-error" id="optionsError" style="display: none; color: #c00; margin: 10px 0; padding: 8px 12px; background: #fee; border-radius: 6px;"></div>
            </div>
            {% endif %}

            <button class="btn btn-add" id="addToCartBtn" data-pk="{{ candle.pk }}" {% if has_options or not candle.is_available %}disabled{% endif %}>
                {% if not candle.is_available %}Нет в наличии{% else %}Добавить в корзину{% endif %}
            </button>

        </div>

        <p class="desc">{{ candle.display_description|linebreaksbr }}</p>

    </div>

</div>

<!-- Image Modal -->

<div class="image-modal" id="imageModal">

    <div class="modal-content" onclick="event.stopPropagation()">

        <span class="modal-close" onclick="closeImageModal()">&times;</span>

        <img id="modalImage" src="" alt="Product Image">

    </div>

</div>

<script>

let galleryIndex = 0;

let touchStartX = null;

function getGalleryImages() {

    const el = document.getElementById('productGallery');

    if (!el) return [];

    const raw = el.getAttribute('data-images') || '';

    if (!raw) return [];

    return raw.split('||').filter(Boolean);

}

function galleryUpdateActiveThumb() {

    const thumbs = document.querySelectorAll('.gallery-thumb');

    thumbs.forEach((t) => t.classList.remove('is-active'));

    const active = document.querySelector(`.gallery-thumb[data-idx="${galleryIndex}"]`);

    if (active) {

        active.classList.add('is-active');

        if (active.scrollIntoView) {

            active.scrollIntoView({block: 'nearest', inline: 'nearest'});

        }

    }

}

function gallerySet(idx) {

    const imgs = getGalleryImages();

    if (!imgs.length) return;

    galleryIndex = Math.max(0, Math.min(idx, imgs.length - 1));

    const imgEl = document.getElementById('productImage');

    if (imgEl) imgEl.src = imgs[galleryIndex];

    galleryUpdateActiveThumb();

}

function gallerySetFromThumb(btn) {

    const idx = Number(btn && btn.dataset ? btn.dataset.idx : 0);

    gallerySet(isNaN(idx) ? 0 : idx);

}

function galleryPrev() {

    const imgs = getGalleryImages();

    if (!imgs.length) return;

    galleryIndex = (galleryIndex - 1 + imgs.length) % imgs.length;

    gallerySet(galleryIndex);

}

function galleryNext() {

    const imgs = getGalleryImages();

    if (!imgs.length) return;

    galleryIndex = (galleryIndex + 1) % imgs.length;

    gallerySet(galleryIndex);

}

document.addEventListener('keydown', function(e) {

    const imgs = getGalleryImages();

    if (imgs.length <= 1) return;

    if (document.body.classList.contains('image-modal-open')) return;

    if (e.key === 'ArrowLeft') galleryPrev();

    if (e.key === 'ArrowRight') galleryNext();

});

document.addEventListener('DOMContentLoaded', function() {

    galleryUpdateActiveThumb();

    const imgEl = document.getElementById('productImage');

    if (!imgEl) return;

    imgEl.addEventListener('touchstart', function(e) {

        if (!e.touches || !e.touches.length) return;

        touchStartX = e.touches[0].clientX;

    }, {passive: true});

    imgEl.addEventListener('touchend', function(e) {

        if (touchStartX === null) return;

        const changed = e.changedTouches && e.changedTouches[0];

        if (!changed) return;

        const dx = changed.clientX - touchStartX;

        touchStartX = null;

        if (Math.abs(dx) < 30) return;

        if (dx > 0) galleryPrev();

        else galleryNext();

    }, {passive: true});

});

function openImageModal(img) {

    const modal = document.getElementById('imageModal');

    const modalImg = document.getElementById('modalImage');

    modalImg.src = img.src;

    modal.classList.add('active');

    document.body.classList.add('image-modal-open');

}

function closeImageModal() {

    const modal = document.getElementById('imageModal');

    modal.classList.remove('active');

    document.body.classList.remove('image-modal-open');

}

const modal = document.getElementById('imageModal');

modal.onclick = function(e) {

    if (e.target === modal) {

        closeImageModal();

    }

};

document.onkeydown = function(e) {

    if (e.key === 'Escape') {

        closeImageModal();

    }

};

// ========== КОНФИГУРАТОР ТОВАРОВ ==========

(function() {
    const hasOptions = document.getElementById('productOptions') !== null;
    if (!hasOptions) return;

    const productImageEl = document.getElementById('productImage');
    const baseImageSrc = productImageEl ? productImageEl.getAttribute('src') : null;

    const basePrice = parseFloat('{{ candle.price }}');
    let currentPriceModifier = 0;

    const addToCartBtn = document.getElementById('addToCartBtn');
    const optionsError = document.getElementById('optionsError');
    const priceEl = document.getElementById('productPrice');

    function updatePrice() {
        let modifier = 0;
        document.querySelectorAll('.option-input').forEach(input => {
            if (input.tagName === 'SELECT') {
                const selected = input.options[input.selectedIndex];
                if (selected) {
                    modifier += parseFloat(selected.dataset.priceModifier || 0);
                }
            } else if (input.type === 'radio' && input.checked) {
                modifier += parseFloat(input.dataset.priceModifier || 0);
            } else if (input.type === 'hidden' && input.value) {
                const group = input.closest('.option-buttons-group');
                if (group) {
                    const activeBtn = group.querySelector('.option-btn.active');
                    if (activeBtn) {
                        modifier += parseFloat(activeBtn.dataset.priceModifier || 0);
                    }
                }
            }
        });
        currentPriceModifier = modifier;
        const finalPrice = basePrice + modifier;
        priceEl.textContent = finalPrice.toFixed(0) + ' ₴';
    }

    function validateOptions() {
        let isValid = true;
        const missing = [];

        document.querySelectorAll('.option-item[data-required="true"]').forEach(item => {
            const optionId = item.dataset.optionId;
            const input = item.querySelector('.option-input');
            let hasValue = false;

            if (input.tagName === 'SELECT') {
                hasValue = input.value !== '';
            } else if (input.type === 'radio') {
                const checked = item.querySelector('input[type="radio"]:checked');
                hasValue = !!checked;
            } else if (input.type === 'hidden') {
                hasValue = input.value !== '';
            }

            if (!hasValue) {
                isValid = false;
                const label = item.querySelector('.option-label').textContent.trim();
                missing.push(label.replace('*', '').trim());
            }
        });

        return { isValid, missing };
    }

    function updateButtonState() {
        const { isValid, missing } = validateOptions();
        addToCartBtn.disabled = !isValid;

        if (!isValid) {
            optionsError.style.display = 'block';
            optionsError.textContent = 'Пожалуйста, выберите: ' + missing.join(', ');
        } else {
            optionsError.style.display = 'none';
            optionsError.textContent = '';
        }
    }

    function getSelectedOptions() {
        const options = {};
        document.querySelectorAll('.option-input').forEach(input => {
            const optionId = input.dataset.optionId;
            let value = null;

            if (input.tagName === 'SELECT') {
                value = input.value || null;
            } else if (input.type === 'radio' && input.checked) {
                value = input.value;
            } else if (input.type === 'hidden') {
                value = input.value || null;
            }

            if (value) {
                options[optionId] = value;
            }
        });
        return options;
    }

    document.querySelectorAll('.option-checkbox').forEach(radio => {
        radio.addEventListener('change', function() {
            updatePrice();
            updateButtonState();
            if (productImageEl) {
                const u = this.dataset.imageUrl || '';
                productImageEl.src = u || baseImageSrc || productImageEl.src;
            }
        });
    });

    document.querySelectorAll('.option-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            updatePrice();
            updateButtonState();
            if (productImageEl) {
                const u = this.dataset.imageUrl || '';
                productImageEl.src = u || baseImageSrc || productImageEl.src;
            }
        });
    });

    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const group = this.closest('.option-buttons-group');
            const hidden = group.querySelector('input[type="hidden"]');

            group.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            hidden.value = this.dataset.valueId;

            updatePrice();
            updateButtonState();

            if (productImageEl) {
                const u = this.dataset.imageUrl || '';
                productImageEl.src = u || baseImageSrc || productImageEl.src;
            }
        });
    });

    addToCartBtn.addEventListener('click', async function() {
        const { isValid } = validateOptions();
        if (!isValid) {
            updateButtonState();
            return;
        }

        const pk = this.dataset.pk;
        const options = getSelectedOptions();

        try {
            const response = await fetch('/cart/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: JSON.stringify({
                    pk: pk,
                    qty: 1,
                    options: options
                })
            });

            const data = await response.json();

            if (data.ok) {
                const cartCounter = document.getElementById('cart-count');
                if (cartCounter) cartCounter.textContent = data.items;

                const btn = addToCartBtn;
                const originalText = btn.textContent;
                btn.textContent = 'Добавлено!';
                btn.classList.add('added');

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('added');
                }, 1500);
            } else {
                optionsError.style.display = 'block';
                optionsError.textContent = data.message || 'Ошибка при добавлении в корзину';
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            optionsError.style.display = 'block';
            optionsError.textContent = 'Ошибка соединения. Попробуйте еще раз.';
        }
    });

    updateButtonState();
})();

</script>

{% endblock %}